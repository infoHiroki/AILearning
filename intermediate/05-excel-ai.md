# Excel + AI活用

**所要時間**: 1.5時間  
**レベル**: 中級  
**前提知識**: [基礎講座群](../basic/)完了

## 学習目標

この講座を修了すると、以下ができるようになります：
- ExcelとAIを効果的に組み合わせて使える
- VBA・マクロの自動生成と活用ができる
- データ分析・可視化を大幅に効率化できる
- 複雑な関数・数式をAIで生成できる

## 📋 目次

1. [Excel + AI活用の基本概念](#excel--ai活用の基本概念)
2. [関数・数式の自動生成](#関数数式の自動生成)
3. [VBA・マクロの自動作成](#vbaマクロの自動作成)
4. [データ分析の効率化](#データ分析の効率化)
5. [グラフ・可視化の自動化](#グラフ可視化の自動化)
6. [業務別活用パターン](#業務別活用パターン)
7. [トラブルシューティング](#トラブルシューティング)

---

## Excel + AI活用の基本概念

### 組み合わせ活用のメリット

#### ✅ 効率化の効果
- **関数作成**: 90%の時間短縮
- **VBA開発**: 70-80%の時間短縮
- **データ分析**: 60-70%の時間短縮
- **レポート作成**: 50-60%の時間短縮

#### ✅ 品質向上の効果
- エラーの少ない正確な関数
- 保守性の高いVBAコード
- 標準化されたフォーマット
- 再利用可能なテンプレート

### AIが得意なExcel作業

#### 🎯 高い効果が期待できるもの
- **複雑な関数の作成**: 条件分岐、配列関数等
- **VBA・マクロの生成**: 繰り返し処理、自動化
- **データクリーニング**: 整形、重複除去等
- **分析用数式**: 統計関数、財務関数等

#### ⚠️ 人間の確認が重要なもの
- **業務ロジック**: ビジネスルールの実装
- **データの妥当性**: 結果の正確性確認
- **パフォーマンス**: 処理速度の最適化

---

## 関数・数式の自動生成

### 基本的な関数生成プロンプト

```
「以下の条件でExcel関数を作成してください。

【要求内容】
[具体的にやりたいこと]

【データ構造】
- セル範囲: [A1:C100など]
- 列の内容: A列は[内容]、B列は[内容]...
- データ型: 数値/文字列/日付

【条件・制約】
[具体的な条件や制約]

【出力形式】
- 関数式のみ
- 簡単な説明
- 使用例

注意: Excel 365/2021で動作する関数でお願いします。」
```

### 実践例1: 複雑な条件分岐

#### ビジネスシナリオ
売上成績に基づく評価ランクの自動判定

#### プロンプト
```
「営業成績に基づく評価ランクを自動判定するExcel関数を作成してください。

【データ構造】
- A列: 営業担当者名
- B列: 売上金額（数値）
- C列: 目標達成率（%）
- D列: 顧客満足度（1-5の数値）

【評価条件】
- S評価: 売上1000万以上 かつ 達成率120%以上 かつ 満足度4.5以上
- A評価: 売上800万以上 かつ 達成率110%以上 かつ 満足度4.0以上
- B評価: 売上600万以上 かつ 達成率100%以上 かつ 満足度3.5以上
- C評価: 上記以外

【出力セル】
E列に評価ランクを表示」
```

#### AI生成関数例
```excel
=IF(AND(B2>=10000000,C2>=120,D2>=4.5),"S評価",
 IF(AND(B2>=8000000,C2>=110,D2>=4),"A評価",
 IF(AND(B2>=6000000,C2>=100,D2>=3.5),"B評価","C評価")))
```

### 実践例2: 配列関数の活用

#### プロンプト
```
「以下の条件で複数条件による集計を行う配列関数を作成してください。

【データ】
- A列: 商品名
- B列: カテゴリ
- C列: 地域
- D列: 売上金額

【集計条件】
特定のカテゴリかつ特定の地域の売上合計を求めたい
カテゴリ: セルF1で指定
地域: セルG1で指定

【出力】
セルH1に集計結果を表示」
```

#### AI生成関数例
```excel
=SUMIFS(D:D,B:B,F1,C:C,G1)

または動的配列関数版（Excel 365）:
=SUM((B:B=F1)*(C:C=G1)*D:D)
```

### 高度な関数生成例

#### 動的なレポート作成
```
プロンプト:
「月次売上レポートの自動生成関数を作成してください。

【要件】
- 指定した月の売上データを自動抽出
- 商品別、地域別の売上を計算
- 前年同期比も表示
- 月はセルで指定（YYYY-MM形式）

【データ構造】
- シート名: 売上データ
- 日付列: A列（YYYY-MM-DD）
- 商品列: B列
- 地域列: C列  
- 売上列: D列

【出力形式】
別シートに商品×地域のクロス集計表を作成」
```

---

## VBA・マクロの自動作成

### VBA生成の基本プロンプト

```
「以下の作業を自動化するVBAマクロを作成してください。

【自動化したい作業】
[具体的な作業内容]

【対象データ】
- ワークブック: [ファイル名または"アクティブブック"]
- シート: [シート名または"アクティブシート"]
- 範囲: [具体的なセル範囲]

【処理内容】
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

【エラー処理】
- エラー時の対応
- 確認メッセージの有無

【実行方法】
ボタンクリック/ショートカットキー/自動実行

注意: エラーハンドリングとコメントを含めてください。」
```

### 実践例1: データ整形マクロ

#### ビジネスシナリオ
外部システムから出力されたCSVファイルの整形自動化

#### プロンプト
```
「CSVファイルのデータ整形を自動化するVBAマクロを作成してください。

【処理内容】
1. CSVファイルを開く（ファイル選択ダイアログ表示）
2. 以下の整形処理を実行：
   - 空白行の削除
   - 重複データの削除（A列とB列の組み合わせで判定）
   - 日付列（C列）をYYYY/MM/DD形式に統一
   - 数値列（D～F列）の桁区切りカンマ設定
3. 整形結果を新しいワークブックに保存
4. 元のCSVファイルは閉じる

【エラー処理】
- ファイルが選択されなかった場合
- データ形式が想定と異なる場合
- 保存エラーの場合」
```

#### AI生成VBAコード例
```vb
Sub CSVDataFormatting()
    Dim ws As Worksheet
    Dim filePath As String
    Dim newWb As Workbook
    
    On Error GoTo ErrorHandler
    
    ' ファイル選択ダイアログ
    filePath = Application.GetOpenFilename("CSV Files (*.csv), *.csv", , "CSVファイルを選択してください")
    
    If filePath = "False" Then
        MsgBox "ファイルが選択されませんでした。", vbInformation
        Exit Sub
    End If
    
    ' CSVファイルを開く
    Workbooks.Open filePath
    Set ws = ActiveSheet
    
    ' データ整形処理
    With ws
        ' 空白行削除
        .Cells.SpecialCells(xlCellTypeBlanks).EntireRow.Delete
        
        ' 重複削除（A列とB列の組み合わせ）
        .UsedRange.RemoveDuplicates Columns:=Array(1, 2), Header:=xlYes
        
        ' 日付形式統一（C列）
        .Columns("C").NumberFormat = "yyyy/mm/dd"
        
        ' 数値列の桁区切り設定（D～F列）
        .Range("D:F").NumberFormat = "#,##0"
    End With
    
    ' 新しいワークブックに保存
    Set newWb = Workbooks.Add
    ws.UsedRange.Copy newWb.Sheets(1).Range("A1")
    
    ' 保存
    newWb.SaveAs Replace(filePath, ".csv", "_formatted.xlsx")
    
    ' 元ファイルを閉じる
    Workbooks(Dir(filePath)).Close SaveChanges:=False
    
    MsgBox "データ整形が完了しました。", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "エラーが発生しました: " & Err.Description, vbCritical
End Sub
```

### 実践例2: レポート自動生成マクロ

#### プロンプト
```
「月次売上レポートを自動生成するVBAマクロを作成してください。

【処理内容】
1. 売上データシートから当月データを抽出
2. 以下の分析を実行：
   - 商品別売上TOP10
   - 地域別売上グラフ
   - 前年同期比較表
3. レポート用新シートを作成
4. 分析結果をレポートシートに配置
5. グラフも自動生成

【データ構造】
- シート名: "売上データ"
- A列: 日付, B列: 商品名, C列: 地域, D列: 売上金額

【レポート形式】
- タイトル: "○年○月 売上レポート"
- TOP10表: A1:B11
- 地域別グラフ: D1:K15
- 前年比較表: A16:C26」
```

### VBA学習・デバッグ支援

#### コード解説プロンプト
```
「以下のVBAコードについて、初心者向けに詳しく解説してください。

【VBAコード】
[コードを貼り付け]

【解説項目】
1. コード全体の目的・機能
2. 各行の処理内容
3. 使用している関数・メソッドの説明
4. エラーハンドリングの説明
5. 改善点・注意点

【対象読者】
VBA初心者（Excelは使える）」
```

#### デバッグ支援プロンプト
```
「以下のVBAコードでエラーが発生します。原因と修正方法を教えてください。

【エラー内容】
[エラーメッセージ]

【エラー発生行】
[該当行番号とコード]

【VBAコード全体】
[コード全体を貼り付け]

【期待する動作】
[本来やりたいこと]

【修正版コード】
修正したコードと修正理由を教えてください。」
```

---

## データ分析の効率化

### 統計分析の自動化

#### 基本統計量の算出
```
プロンプト:
「売上データの基本統計分析を行うExcel関数・VBAを作成してください。

【分析項目】
- 平均値、中央値、最頻値
- 標準偏差、分散
- 最大値、最小値、範囲
- 四分位数（Q1, Q3）
- 歪度、尖度

【データ】
- D列: 売上金額（1000行程度）
- 欠損値やエラー値を除外して計算

【出力形式】
分析結果シートに統計量一覧表として出力
グラフ（ヒストグラム、箱ひげ図）も作成」
```

### 相関分析・回帰分析

#### プロンプト例
```
「複数の要因と売上の関係を分析するExcelソリューションを作成してください。

【データ構造】
- A列: 店舗名
- B列: 売上金額
- C列: 広告費
- D列: 客単価
- E列: 来店者数
- F列: 立地スコア（1-10）

【分析内容】
1. 相関分析（売上と各要因の相関係数）
2. 散布図とトレンドライン
3. 重回帰分析（可能な範囲で）
4. 予測モデルの作成

【出力】
- 相関係数マトリックス
- 散布図グラフ
- 回帰式と予測精度
- 要因別インパクト分析」
```

### 時系列分析

#### プロンプト例
```
「月次売上データの時系列分析を行うExcelツールを作成してください。

【データ】
- A列: 年月（YYYY-MM）
- B列: 売上金額
- 過去36ヶ月分のデータ

【分析項目】
1. トレンド分析（移動平均、線形近似）
2. 季節性分析（月別平均、季節指数）
3. 売上予測（3ヶ月先まで）
4. 異常値検出

【可視化】
- 実績値と移動平均のグラフ
- 季節性パターンのグラフ
- 予測値を含むトレンドグラフ」
```

---

## グラフ・可視化の自動化

### 動的グラフの作成

#### ダッシュボード作成プロンプト
```
「売上ダッシュボードを作成するExcelソリューションを開発してください。

【要件】
1. ドロップダウンでの期間・地域・商品選択
2. 選択に応じてグラフが自動更新
3. KPI表示（売上、利益率、前年比）
4. トレンドグラフ、円グラフ、棒グラフを配置

【データソース】
- 売上データシート（日付、商品、地域、売上、利益）

【ダッシュボード構成】
- 上部: フィルター用ドロップダウン
- 左上: KPI表示エリア  
- 右上: トレンドグラフ
- 下部: 商品別・地域別分析グラフ

【技術要件】
- VBAまたは関数での動的更新
- ユーザーフレンドリーなUI
- エラーハンドリング」
```

### グラフの自動フォーマット

#### プロンプト例
```
「企業ブランドに統一されたグラフを自動生成するVBAマクロを作成してください。

【ブランド仕様】
- メインカラー: #1f4e79（ダークブルー）
- サブカラー: #70ad47（グリーン）
- アクセントカラー: #ffc000（オレンジ）
- フォント: メイリオ, 12pt
- グラフタイトル: 14pt, 太字

【機能】
1. 選択されたグラフを上記仕様で自動フォーマット
2. データラベルの自動設定
3. 軸の書式設定（桁区切り、単位表示等）
4. 凡例の位置・スタイル統一

【対応グラフタイプ】
棒グラフ、折れ線グラフ、円グラフ、散布図」
```

---

## 業務別活用パターン

### 営業・マーケティング部門

#### 顧客分析ツール
```
プロンプト:
「顧客分析ダッシュボードを作成してください。

【分析項目】
- RFM分析（最新購入日、頻度、金額）
- 顧客ライフタイムバリュー
- 購買パターン分析
- 顧客セグメンテーション

【データ構造】
顧客ID、購入日、商品、金額、顧客属性

【出力】
- 顧客スコアリング
- セグメント別分析
- アクションプラン提案
- 可視化ダッシュボード」
```

### 財務・経理部門

#### 財務分析ツール
```
プロンプト:
「財務諸表分析を自動化するExcelツールを作成してください。

【分析項目】
- 収益性分析（ROA、ROE、売上利益率等）
- 安全性分析（流動比率、当座比率等）
- 効率性分析（総資産回転率、棚卸回転率等）
- 成長性分析（売上成長率、利益成長率等）

【入力】
- 損益計算書データ
- 貸借対照表データ
- 過去3年分の比較

【出力】
- 財務指標一覧表
- 時系列トレンドグラフ
- 業界平均との比較
- 財務健全性評価」
```

### 人事・総務部門

#### 人事データ分析
```
プロンプト:
「人事データの分析・可視化ツールを作成してください。

【分析対象】
- 従業員満足度調査結果
- 離職率・定着率
- 残業時間・有給取得率
- 人件費・生産性指標

【機能】
1. 部門別・職位別分析
2. 時系列トレンド分析
3. 相関分析（満足度と離職率等）
4. アラート機能（基準値超過時）

【可視化】
- ダッシュボード形式
- 月次レポート自動生成
- グラフ・チャートの自動更新」
```

---

## トラブルシューティング

### よくあるエラーと対処法

#### ❌ 問題1: 関数エラー「#VALUE!」

**原因と対処法**
```
プロンプト:
「以下のExcel関数で#VALUE!エラーが発生します。原因と修正方法を教えてください。

【エラー発生関数】
[関数式を貼り付け]

【データ状況】
- セル範囲: [範囲]
- データ型: [数値/文字列/日付]
- 空白セルの有無: [あり/なし]

【期待する結果】
[本来得たい結果]

【修正案】
エラーハンドリングを含む修正版関数も提案してください。」
```

#### ❌ 問題2: VBAの実行時エラー

**デバッグ支援プロンプト**
```
「VBA実行時に以下のエラーが発生します。デバッグ方法と修正案を教えてください。

【エラー詳細】
エラー番号: [番号]
エラーメッセージ: [メッセージ]
エラー発生行: [行番号とコード]

【VBAコード】
[エラー発生部分を含むコード]

【実行環境】
Excel バージョン: [バージョン]
データ規模: [行数・列数]

【修正方針】
- エラーハンドリング強化
- パフォーマンス最適化
- 汎用性向上」
```

### パフォーマンス最適化

#### 大量データ処理の最適化
```
プロンプト:
「10万行のデータ処理でExcelの動作が重くなります。最適化方法を教えてください。

【現在の処理】
[現在の処理方法・関数・VBAコード]

【データ規模】
- 行数: 約10万行
- 列数: 20列程度
- ファイルサイズ: [サイズ]

【最適化したい項目】
- 計算速度の改善
- メモリ使用量の削減
- ファイルサイズの縮小
- 安定性の向上

【最適化提案】
- 効率的な関数・VBA記述方法
- データ構造の改善
- 設定変更による高速化」
```

---

## 💡 実践演習

### 演習1: 複雑な関数作成

以下の条件で関数を作成してください：

```
【シナリオ】
従業員の評価システム

【条件】
- 基本給（B列）× スキルレベル係数（C列：1.0-1.5）× 評価係数
- 評価係数: S評価=1.3, A評価=1.2, B評価=1.1, C評価=1.0
- 評価はD列に文字列で入力
- 結果をE列に表示

【作成する関数】:
[ここに関数を記述してください]
```

### 演習2: VBAマクロ作成

以下のタスクを自動化するVBAを作成してください：

```
【タスク】
1. アクティブシートの使用範囲をコピー
2. 新しいワークブックを作成
3. コピーしたデータを貼り付け
4. ファイル名を「データ_YYYYMMDD.xlsx」で保存
5. 元のワークブックに戻る

【作成するVBAコード】:
[ここにVBAコードを記述してください]
```

### 演習3: ダッシュボード設計

売上データを使った簡単なダッシュボードを設計してください：

```
【要件】
- 月別売上トレンド（折れ線グラフ）
- 商品別売上（円グラフ）
- KPI表示エリア（売上合計、平均、前年比）
- フィルター機能（年度選択）

【設計内容】:
1. レイアウト設計:
2. 使用する関数・機能:
3. データ構造:
4. 更新方法:
```

---

## 📚 参考資料

### Excel関数・VBA学習リソース
- Microsoft公式ドキュメント
- Excel関数リファレンス
- VBA入門ガイド
- 実践的なサンプルコード集

### 分析手法・統計学習
- ビジネス統計学の基礎
- データ分析手法ガイド
- ダッシュボード設計原則

---

## ✅ 理解度確認

この講座の内容を理解できたか、以下で確認してください：

1. ExcelとAIを組み合わせた効率化ができますか？
2. 複雑な関数・数式をAIで生成できますか？
3. VBA・マクロの自動作成と修正ができますか？
4. データ分析の自動化を実装できますか？
5. 業務に応じたExcelツールを設計できますか？
6. エラーの対処とパフォーマンス最適化ができますか？

すべて「はい」なら次の講座に進めます。

---

**次の講座**: [スプレッドシート + GAS](06-spreadsheet-gas.md)

<!-- 動画埋め込み用プレースホルダー -->
<!-- VIDEO: excel-ai-overview.mp4 -->
<!-- VIDEO: formula-generation.mp4 -->
<!-- VIDEO: vba-automation.mp4 -->
<!-- VIDEO: dashboard-creation.mp4 -->